services:
  nginx:
    # default ports 80, 443 - expose mapping as needed to host
    image: nginx:1.13-alpine
    container_name: lazy_rabbit_nginx
    restart: unless-stopped

    ports:
      - "1980:80"    # http
      - "1981:443"   # httpsv
    volumes:
      - ../frontend/dist:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certs:/etc/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - web
    networks:
      - lazy-rabbit-net

  web:
    container_name: lazy_rabbit_reminder
    build: ../backend
    ports:
      - "8000:2025"
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
      - DB_URL=${DB_URL}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USE_SSL=${MAIL_USE_SSL}
      - MAIL_USE_TLS=${MAIL_USE_TLS}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_SENDER=${MAIL_SENDER}
      - MAIL_RECEIVER=${MAIL_RECEIVER}
    volumes:
      - .env:/root/.env
      - ../doc:/root/doc
      - ../frontend:/root/frontend
      - ./config.yaml:/root/config/config.yaml
    depends_on:
      - pgvector
      - redis
      - nats
    networks:
      - lazy-rabbit-net

  pgvector:
    image: ankane/pgvector
    container_name: pgvector
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432"
    volumes:
      - pgvector-data:/var/lib/postgresql/data
    networks:
      - lazy-rabbit-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - lazy-rabbit-net
    restart: unless-stopped
    command: |
      sh -c "
        redis-server /usr/local/etc/redis/redis.conf --requirepass $${REDIS_PASSWORD}
      "
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-lazy-rabbit}

  nats:
    container_name: lazy_rabbit_nats
    image: nats:2.10.20-alpine
    restart: always
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring port
      - "6222:6222"   # Cluster routing port
    command: 
      - "--jetstream"
      - "--store_dir=/data"
      - "--http_port=8222"
    volumes:
      - nats_data:/data
    networks:
      - lazy-rabbit-net
    environment:
      - TZ=Asia/Shanghai
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  pgweb:
    image: sosedoff/pgweb
    container_name: pgweb
    # Remove port exposure as nginx will handle it
    expose:
      - "8081"
    ports:
      - "8081:8081"
    environment:
      - PGWEB_DATABASE_URL=${DB_URL}
    depends_on:
      - pgvector
    networks:
      - lazy-rabbit-net
    restart: unless-stopped

  plantuml:
    image: plantuml/plantuml-server:jetty
    container_name: plantuml-server
    # Remove port exposure as nginx will handle it
    expose:
      - "8080"
    ports:
      - "8002:8080"
    networks:
      - lazy-rabbit-net
    restart: unless-stopped

volumes:
    pgvector-data:
      driver: local
    redis-data:
      driver: local
    nats_data:
      driver: local

networks:
  lazy-rabbit-net:
    driver: bridge

